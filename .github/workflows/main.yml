name: Deploy to Tencent Cloud
on:
  push:
    branches: [ main ]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout
        uses: actions/checkout@v4

      # 2. è®¾ç½®Node.jsç¯å¢ƒ (å…³é”®æ­¥éª¤ï¼Œè¯­æ³•å·²ä¿®æ­£)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      # 3. å®‰è£…ä¾èµ–å¹¶æ„å»º (åœ¨CIç¯å¢ƒä¸€æ¬¡æ€§å®Œæˆ)
      - name: Install and Build
        run: |
          npm ci
          npm run build
      # å…³é”®æ­¥éª¤1ï¼ˆä¼˜åŒ–ç‰ˆï¼‰ï¼šä½¿ç”¨ rsync é«˜æ•ˆåŒæ­¥æ–‡ä»¶åˆ°æœåŠ¡å™¨
      - name: ğŸš€ Rsync files to Server
        uses: burnett01/rsync-deployments@7.1.0
        with:
          # è¿æ¥å‚æ•°
          switches: -avz --delete --exclude='.git/' # å…³é”®å‚æ•°ï¼Œè§ä¸‹æ–¹è§£é‡Š
          path: ./build/                      # æœ¬åœ°è¦åŒæ­¥çš„ç›®å½•
          remote_path: /home/ubuntu/my-website/ # æœåŠ¡å™¨ç›®æ ‡ç›®å½•
          remote_host: ${{ secrets.BUCKET }}    # æœåŠ¡å™¨ IP
          remote_user: ${{ secrets.USERNAME }} # ç™»å½•ç”¨æˆ·
          remote_key: ${{ secrets.TENCENT_SECRET_KEY }} # SSH ç§é’¥
          source: './build/*'                 # ä¸Šä¼ æ„å»ºäº§ç‰©
          target: '/home/ubuntu/my-website/'  # æœåŠ¡å™¨ç›®æ ‡ç›®å½•

      # 5. åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œå¿…è¦å‘½ä»¤ (å¦‚é‡å¯WebæœåŠ¡)
      - name: Restart Web Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.BUCKET }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd /home/ubuntu/my-website
            # è¿™é‡Œä¸éœ€è¦å†æ„å»ºï¼åªéœ€å¤„ç†éƒ¨ç½²åçš„æ“ä½œï¼Œä¾‹å¦‚ï¼š
            # 1. å¦‚æœä½¿ç”¨Nginxï¼Œå°†buildå†…å®¹å¤åˆ¶åˆ°Webæ ¹ç›®å½•
            # sudo cp -r build/* /var/www/html/
            # 2. é‡å¯Nginx
            # sudo systemctl restart nginx
            echo "éƒ¨ç½²å®Œæˆï¼"
